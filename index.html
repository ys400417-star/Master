<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Delivery Master V56.8</title>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"ë°°ë‹¬ë§ˆìŠ¤í„°","short_name":"ë°°ë‹¬ë§ˆìŠ¤í„°","start_url":".","display":"standalone","background_color":"#09090b","theme_color":"#09090b","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/726/726455.png","sizes":"512x512","type":"image/png"}]}'>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { bg: "#09090b", fg: "#fafafa", primary: "#f97316", secondary: "#27272a", muted: "#a1a1aa", card: "#18181b", success: "#22c55e", danger: "#ef4444" } } }
        }
    </script>
    <style>
        html { overflow: hidden; height: 100%; overscroll-behavior: none; }
        body { 
            background-color: #09090b; color: #fafafa; 
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom); 
            overflow: hidden; height: 100%; height: 100dvh; 
            width: 100%; position: fixed; 
            display: flex; flex-direction: column; 
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        .glass { background: rgba(24, 24, 27, 0.98); border-bottom: 1px solid #27272a; z-index: 50; }
        #mainScroll { 
            flex: 1; overflow-y: scroll; 
            -webkit-overflow-scrolling: touch; overscroll-behavior: contain; 
            position: relative; z-index: 10; padding-bottom: 200px; 
            touch-action: pan-y;
        }
        .lovable-card { background-color: #18181b; border: 1px solid #27272a; border-radius: 12px; transition: transform 0.1s; position: relative; z-index: 20; user-select: none; -webkit-user-select: none; }
        .lovable-card:active { transform: scale(0.98); }
        .nav-active { color: #f97316; } .nav-item { color: #71717a; transition: color 0.2s; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.2s; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .page { display: none; width: 100%; height: 100%; } .page.active { display: block; }
        #map { height: 100%; width: 100%; background: #222; }
        .map-pill { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(0,0,0,0.8); color: white; padding: 8px 20px; border-radius: 30px; border: 1px solid #444; font-weight: bold; pointer-events: none; white-space: nowrap; }
        .gps-btn { position: absolute; bottom: 100px; right: 20px; z-index: 1000; background: #27272a; color: white; padding: 12px; border-radius: 50%; border: 1px solid #444; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .pulse-dot { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .combat-mode { border: 2px solid rgba(239, 68, 68, 0.6); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { border-color: rgba(239, 68, 68, 0.6); } 50% { border-color: rgba(239, 68, 68, 1); } 100% { border-color: rgba(239, 68, 68, 0.6); } }
        input[type="time"]::-webkit-calendar-picker-indicator, input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .offline-banner { display:none; position:fixed; top:0; left:0; right:0; height:4px; background:red; z-index:99999; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden select-none overscroll-none">

    <div id="offlineIndicator" class="offline-banner"></div>
    <div id="toastContainer" class="fixed bottom-24 left-4 right-4 z-[9999] flex flex-col gap-2 pointer-events-none"></div>
    <input type="file" id="fileInput" class="hidden" accept=".json" onchange="loadBackupFile(this)">

    <div id="archiveModal" class="modal-overlay">
        <div class="bg-[#18181b] w-[90%] max-w-sm rounded-2xl border border-gray-800 p-6 shadow-2xl transform transition-all scale-100 h-[70vh] flex flex-col">
            <h3 class="text-lg font-bold text-white mb-4 text-center flex justify-between items-center"><span>ì•„ì¹´ì´ë¸Œ ìˆ˜ì •</span><button onclick="closeArchiveModal()" class="text-gray-500"><i class="fas fa-times"></i></button></h3>
            <input type="hidden" id="archIdx" value="-1">
            <div class="mb-4"><label class="text-xs text-gray-400 font-bold mb-1 block">ë‚ ì§œ</label><input type="date" id="archDate" class="w-full bg-[#27272a] border border-gray-700 rounded-xl p-3 text-white font-bold text-center"></div>
            <div class="grid grid-cols-2 gap-3 mb-4"><div><label class="text-xs text-gray-400 font-bold mb-1 block">ì´ ê±´ìˆ˜</label><input type="tel" id="archCount" class="w-full bg-[#27272a] border border-gray-700 rounded-xl p-3 text-white text-lg font-bold text-center"></div><div><label class="text-xs text-gray-400 font-bold mb-1 block">ì´ ìˆ˜ì…</label><input type="tel" id="archInc" class="w-full bg-[#27272a] border border-gray-700 rounded-xl p-3 text-white text-lg font-bold text-center"></div></div>
            <div class="bg-gray-900 p-3 rounded-xl border border-gray-700 mb-4 flex-1 overflow-y-auto"><h4 class="text-xs font-bold text-primary mb-2"><i class="fas fa-plus-circle mr-1"></i>ì¼ê´„ ì¶”ê°€</h4><div class="flex gap-2 mb-2"><input type="tel" id="bulkCount" class="flex-1 bg-black border border-gray-600 rounded p-2 text-white text-center" placeholder="ê±´ìˆ˜"><input type="tel" id="bulkAmount" class="flex-[2] bg-black border border-gray-600 rounded p-2 text-white text-center" placeholder="ê¸ˆì•¡"></div><button onclick="applyBulkAdd()" class="w-full bg-gray-800 border border-gray-600 text-white font-bold py-2 rounded hover:bg-gray-700">í•©ì‚°í•˜ê¸°</button></div>
            <div class="flex gap-3 mt-auto"><button onclick="deleteArchive()" class="flex-1 py-3 rounded-xl font-bold text-white bg-red-600 active:bg-red-700">ì‚­ì œ</button><button onclick="saveArchive()" class="flex-[2] py-3 rounded-xl font-bold text-black bg-primary">ì €ì¥</button></div>
        </div>
    </div>

    <div id="doctorModal" class="modal-overlay">
        <div class="bg-[#18181b] w-full max-w-sm rounded-2xl border border-gray-800 p-5 shadow-2xl h-[80vh] flex flex-col">
            <h3 class="text-lg font-bold text-red-500 mb-4 flex justify-between items-center"><span>ë°ì´í„° ì§„ë‹¨</span><button onclick="closeDoctorModal()" class="text-gray-500"><i class="fas fa-times"></i></button></h3>
            <div class="flex-1 overflow-y-auto space-y-4">
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-700"><h4 class="text-sm font-bold text-white mb-2">ê¸°ë¡ ë³µêµ¬</h4><div id="recoveryList" class="space-y-2 text-xs"></div></div>
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-700"><h4 class="text-sm font-bold text-white mb-2">ìˆ˜ë™ ë³´ì •</h4><div class="flex gap-2 mb-2"><input type="tel" id="fixCount" class="flex-1 bg-black border border-gray-600 rounded p-2 text-white" placeholder="ê±´ìˆ˜"><input type="tel" id="fixAmount" class="flex-1 bg-black border border-gray-600 rounded p-2 text-white" placeholder="ê¸ˆì•¡"></div><button onclick="addManualFix()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">ê°•ì œ ì¶”ê°€</button></div>
            </div>
        </div>
    </div>

    <div id="completeModal" class="modal-overlay">
        <div class="bg-[#18181b] w-[90%] max-w-xs rounded-2xl border border-gray-800 p-6 shadow-2xl transform transition-all scale-100">
            <h3 class="text-lg font-bold text-white mb-4 text-center" id="modalTitle">ì™„ë£Œ</h3>
            <input type="hidden" id="editLogId" value=""><input type="hidden" id="editArchIdx" value="">
            <div class="flex gap-2 mb-6">
                <div class="relative flex-[2]"><span class="absolute left-3 top-3.5 text-gray-500 font-bold text-lg">â‚©</span><input type="tel" id="modalAmount" inputmode="numeric" pattern="[0-9]*" class="w-full bg-[#27272a] border border-gray-700 rounded-xl p-3 pl-8 text-white text-xl font-black h-14" placeholder="0"></div>
                <div class="relative flex-1"><input type="time" id="modalTime" class="w-full h-14 bg-[#27272a] border border-gray-700 rounded-xl px-1 text-white text-base font-bold text-center appearance-none"></div>
            </div>
            <div id="weatherSection" class="mb-4">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setWeather('sun')" id="w-sun" class="w-btn p-3 rounded-xl border border-gray-700 bg-gray-800 text-gray-400"><i class="fas fa-sun"></i></button>
                    <button onclick="setWeather('cloud')" id="w-cloud" class="w-btn p-3 rounded-xl border border-gray-700 bg-gray-800 text-gray-400"><i class="fas fa-cloud"></i></button>
                    <button onclick="setWeather('rain')" id="w-rain" class="w-btn p-3 rounded-xl border border-gray-700 bg-gray-800 text-gray-400"><i class="fas fa-umbrella"></i></button>
                    <button onclick="setWeather('snow')" id="w-snow" class="w-btn p-3 rounded-xl border border-gray-700 bg-gray-800 text-gray-400"><i class="fas fa-snowflake"></i></button>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-400 bg-gray-800 border border-gray-700">ì·¨ì†Œ</button>
                <button onclick="deleteEntry()" id="btnDelete" class="hidden flex-1 py-3 rounded-xl font-bold text-white bg-red-600">ì‚­ì œ</button>
                <button onclick="submitComplete()" id="btnSave" class="flex-1 py-3 rounded-xl font-bold text-black bg-primary shadow-lg">ì €ì¥</button>
            </div>
        </div>
    </div>

    <div id="missionModal" class="modal-overlay">
        <div class="bg-[#18181b] w-full max-w-sm rounded-2xl border border-gray-800 p-5 shadow-2xl h-[85vh] flex flex-col">
            <h3 class="text-lg font-bold text-white mb-4 flex justify-between items-center"><span>ë¯¸ì…˜ ì„¼í„°</span><button onclick="closeMissionModal()" class="text-gray-500"><i class="fas fa-times"></i></button></h3>
            <div class="bg-gray-900 p-3 rounded-xl mb-4 border border-gray-800">
                <div class="text-xs text-primary font-bold mb-2">ë¯¸ì…˜ ë“±ë¡ (ë‚ ì§œ/ì‹œê°„)</div>
                <div class="flex gap-2 mb-2"><input type="tel" id="newMsnTgt" class="flex-1 bg-[#27272a] rounded-lg px-3 py-2 text-white text-xs border border-gray-700" placeholder="ëª©í‘œ ê±´ìˆ˜"><input type="tel" id="newMsnRwd" class="flex-1 bg-[#27272a] rounded-lg px-3 py-2 text-white text-xs border border-gray-700" placeholder="ë³´ìƒê¸ˆ"></div>
                <div class="flex gap-2 items-center mb-2">
                    <input type="date" id="newMsnDate" class="flex-[1.5] bg-[#27272a] rounded-lg px-2 py-2 text-white text-xs border border-gray-700">
                    <span class="text-gray-500 text-xs">ì˜</span>
                </div>
                <div class="flex gap-2 items-center mb-1">
                    <input type="time" id="newMsnStart" class="flex-1 bg-[#27272a] rounded-lg px-2 py-2 text-white text-xs border border-gray-700 text-center">
                    <span class="text-gray-500">~</span>
                    <input type="time" id="newMsnEnd" class="flex-1 bg-[#27272a] rounded-lg px-2 py-2 text-white text-xs border border-gray-700 text-center">
                    <button onclick="addMission()" class="bg-primary text-black font-bold rounded-lg px-4 py-2 text-xs active:scale-95">ë“±ë¡</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto mb-4 pr-1">
                <div class="text-xs font-bold text-gray-500 mb-2">ì§„í–‰ ì¤‘</div><div id="activeMissionList" class="space-y-2 mb-6"></div>
                <div class="text-xs font-bold text-gray-500 mb-2">ì„±ê³µ ë‚´ì—­</div><div id="doneMissionList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <header class="glass w-full px-5 py-3 shadow-lg shrink-0 z-50 pt-[calc(env(safe-area-inset-top)+12px)]">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-xl font-black italic tracking-tighter flex items-center select-none text-white" onclick="openDataDoctor()">
                <i class="fas fa-cube text-primary mr-2"></i>MASTER <span class="text-xs font-normal text-muted ml-1 not-italic">V56.8</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="openMissionModal()" class="h-8 px-3 text-xs font-bold border border-secondary rounded-lg text-muted hover:text-white flex items-center"><i class="fas fa-flag-checkered mr-1"></i><span id="missionBtnTxt">ë¯¸ì…˜</span></button>
                <button onclick="resetDay()" class="h-8 px-3 text-xs font-bold bg-red-900/10 text-red-500 border border-red-900/30 rounded-lg"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
        <div id="missionBox" class="hidden mb-3 space-y-1.5"></div>
        <div class="grid grid-cols-2 gap-3 h-[50px]">
            <div class="lovable-card px-3 py-2 flex justify-between items-center"><div class="text-[10px] font-bold text-muted">INCOME</div><div class="text-lg font-black text-white tracking-tight"><span id="uiIncome">0</span><span class="text-xs font-medium text-muted ml-1">ì›</span></div></div>
            <div class="lovable-card px-3 py-2 flex justify-between items-center"><div class="text-[10px] font-bold text-muted">COUNT</div><div class="text-lg font-bold text-primary tracking-tight"><span id="uiCount">0</span><span class="text-xs text-muted ml-1">ê±´</span></div></div>
        </div>
    </header>

    <div id="mainScroll" class="bg-[#09090b] px-4 pt-4">
        <div id="p1" class="page active">
            <div id="trackBox" class="lovable-card p-4 mb-4 border-l-4 border-l-gray-600 transition-all duration-300">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-white text-md">ë°°ì°¨ ì¶”ì </h3>
                        <span id="peakBadge" class="hidden text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full animate-pulse font-bold">ğŸ”¥ PEAK</span>
                        <div id="liveDot" class="hidden pulse-dot"></div>
                    </div>
                    <div id="timer" class="text-xs text-gray-400 font-mono mt-1 tabular-nums">00:00:00</div>
                    <button onclick="toggleRun()" id="runBtn" class="bg-gray-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg">ìš´í–‰ì‹œì‘</button>
                </div>
                <div id="trackStats" class="grid grid-cols-3 gap-2 border-t border-gray-800 pt-3 hidden">
                    <div class="text-center"><div class="text-[9px] text-gray-500">ì‹œê°„ë‹¹ìˆ˜ì…</div><div class="text-sm font-bold text-white"><span id="valWage">0</span></div></div>
                    <div class="text-center border-l border-gray-800"><div class="text-[9px] text-gray-500">ì‹œê°„ë‹¹ê±´ìˆ˜</div><div class="text-sm font-bold text-primary"><span id="valPace">0.0</span></div></div>
                    <div class="text-center border-l border-gray-800 cursor-pointer" onclick="setGoal()"><div class="text-[9px] text-gray-500">ëª©í‘œë‹¬ì„±</div><div class="text-sm font-bold text-green-500"><span id="valGoal">0</span>%</div></div>
                </div>
                <div id="coachBox" class="hidden mt-3 pt-2 border-t border-gray-700 text-center cursor-pointer active:bg-gray-800/50 rounded" onclick="setStrategy()">
                    <div class="text-[10px] text-gray-400">ëª©í‘œ <b id="uiTgtCnt" class="text-white">--</b>ê±´ (<b id="uiTgtTime" class="text-white">--:--</b>) <i class="fas fa-cog ml-1"></i></div>
                    <div class="text-xs font-bold mt-1" id="uiMsg">ë¶„ì„ ëŒ€ê¸°ì¤‘...</div>
                </div>
            </div>
            <div id="slotGrid" class="grid grid-cols-2 gap-3 pb-8"></div>
            <div class="h-20 w-full"></div>
        </div>

        <div id="p2" class="page">
            <div class="lovable-card p-4 border border-secondary bg-black/20 mb-4 flex gap-2">
                <button onclick="backup()" class="flex-1 bg-gray-800 text-xs py-2 rounded text-blue-400 border border-gray-700 font-bold active:bg-gray-700"><i class="fas fa-file-export mr-1"></i>ë°±ì—…</button>
                <button onclick="copyBackup()" class="flex-1 bg-gray-800 text-xs py-2 rounded text-yellow-400 border border-gray-700 font-bold active:bg-gray-700"><i class="fas fa-copy mr-1"></i>ë³µì‚¬</button>
                <button onclick="restore()" class="flex-1 bg-gray-800 text-xs py-2 rounded text-green-400 border border-gray-700 font-bold active:bg-gray-700"><i class="fas fa-file-import mr-1"></i>ë³µêµ¬</button>
            </div>
            <div class="lovable-card p-4 bg-gradient-to-br from-[#1e1e24] to-[#2a2a30] border border-gray-700 mb-4 shadow-xl">
                <h3 class="text-sm font-bold text-white mb-3 flex items-center"><i class="fas fa-brain text-primary mr-2"></i>AI ì „ëµ</h3>
                <div id="aiCoachMsg" class="text-xs text-gray-300 mb-3 bg-black/40 p-3 rounded border-l-2 border-primary">ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black/30 p-3 rounded-lg"><div class="text-[10px] text-gray-400">BEST ìš”ì¼</div><div class="text-sm font-bold text-white mt-1" id="recDay">-</div></div>
                    <div class="bg-black/30 p-3 rounded-lg"><div class="text-[10px] text-gray-400">GOLDEN íƒ€ì„</div><div class="text-sm font-bold text-primary mt-1" id="recTime">-</div></div>
                </div>
            </div>
            <div class="lovable-card p-5 bg-[#18181b] border border-gray-800 mb-4">
                <h3 class="text-sm font-bold text-white mb-4">ì‹œê°„ëŒ€ë³„ í†µê³„</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-black/30 p-3 rounded-lg border border-white/5"><div class="text-[10px] text-gray-400">ê±´ë‹¹ í‰ê· </div><div class="text-lg font-bold text-white mt-1"><span id="insAvg">0</span>ì›</div></div>
                    <div class="bg-black/30 p-3 rounded-lg border border-white/5"><div class="text-[10px] text-gray-400">ì‹œê°„ë‹¹ ê±´ìˆ˜</div><div class="text-lg font-bold text-primary mt-1"><span id="insHour">0</span>/h</div></div>
                </div>
                <div id="hourList" class="space-y-1 text-xs border-t border-gray-700 pt-2 max-h-60 overflow-y-auto"></div>
            </div>
            <div class="lovable-card p-4 mb-4"><h3 class="text-xs font-bold text-gray-400 mb-3 flex justify-between"><span>ì˜¤ëŠ˜ ìƒì„¸ (ìˆ˜ì •)</span><i class="fas fa-pen text-[10px]"></i></h3><div id="logList" class="space-y-2"></div></div>
            <button onclick="openArchiveCreator()" class="w-full bg-gray-800 border border-gray-700 text-gray-400 text-xs font-bold py-3 rounded-xl mb-4">+ ê³¼ê±° ê¸°ë¡ ì¶”ê°€/ìƒì„±</button>
            <div class="lovable-card p-4 mb-4"><h3 class="text-xs font-bold text-gray-400 mb-3 flex justify-between"><span>ê³¼ê±° ì•„ì¹´ì´ë¸Œ (ìˆ˜ì •)</span><i class="fas fa-pen text-[10px]"></i></h3><div id="archList" class="space-y-3"></div></div>
            <div class="h-40 w-full"></div>
        </div>

        <div id="p3" class="page relative h-full w-full">
            <div id="map" class="z-0"></div>
            <div class="map-pill shadow-lg"><i class="fas fa-motorcycle text-primary mr-1"></i> <span id="uiDist">0.0</span> km</div>
            <button onclick="recenterMap()" class="gps-btn active:bg-gray-700 active:scale-95 transition-all"><i class="fas fa-crosshairs text-xl"></i></button>
        </div>
    </div>

    <nav class="fixed bottom-6 left-6 right-6 h-16 glass rounded-2xl border border-secondary flex justify-around items-center shadow-2xl z-50 pb-[calc(env(safe-area-inset-bottom))]">
        <button onclick="go(1)" id="n1" class="nav-item nav-active flex flex-col items-center w-1/3 active:scale-90 transition-transform"><i class="fas fa-th-large text-lg mb-1"></i><span class="text-[10px] font-bold">ë°°ì°¨</span></button>
        <button onclick="go(2)" id="n2" class="nav-item text-gray-500 flex flex-col items-center w-1/3 active:scale-90 transition-transform"><i class="fas fa-chart-line text-lg mb-1"></i><span class="text-[10px] font-bold">ì¸ì‚¬ì´íŠ¸</span></button>
        <button onclick="go(3)" id="n3" class="nav-item text-gray-500 flex flex-col items-center w-1/3 active:scale-90 transition-transform"><i class="fas fa-map-marked-alt text-lg mb-1"></i><span class="text-[10px] font-bold">ì§€ë„</span></button>
    </nav>

<script>
    const KEY = 'masterV56_8'; 
    const DEFAULT_DATA = { date: new Date().toDateString(), logs: [], arch: [], slots: [0,0,0,0,0,0], slotTs: [0,0,0,0,0,0], missions: [], doneMissions: [], dist: 0, path: [], run: {on:false, start:null, goal:150000, tCnt:40, tTime:"21:00"} };
    let d = JSON.parse(JSON.stringify(DEFAULT_DATA));
    let map, poly, activeSlot=null, selW='sun', timerInt=null, watchId=null, curPos = {lat:null, lng:null};
    let isOffline = false;

    // Scroll Lock
    const mainScroll = document.getElementById('mainScroll');
    let touchStartY = 0;
    if(mainScroll) {
        mainScroll.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, { passive: false });
        mainScroll.addEventListener('touchmove', e => {
            const deltaY = e.touches[0].clientY - touchStartY;
            if (mainScroll.scrollTop <= 0 && deltaY > 0) e.preventDefault();
        }, { passive: false });
    }
    document.body.addEventListener('touchmove', e => { if (!e.target.closest('#mainScroll')) e.preventDefault(); }, { passive: false });

    window.addEventListener('online', () => { isOffline=false; document.getElementById('offlineIndicator').style.display='none'; toast("ì˜¨ë¼ì¸"); });
    window.addEventListener('offline', () => { isOffline=true; document.getElementById('offlineIndicator').style.display='block'; toast("ì˜¤í”„ë¼ì¸"); });

    const $ = (id) => document.getElementById(id);
    const setText = (id, val) => { const el=$(id); if(el) el.innerText=val; };
    const toast = (msg) => {
        const t = $('toastContainer'); const el = document.createElement('div');
        el.className = "bg-gray-800 text-white px-4 py-2 rounded mb-2 border border-gray-600 text-sm shadow-lg animate-[fadeIn_0.2s_ease-out]";
        el.innerHTML = `<i class="fas fa-info-circle text-primary mr-2"></i>${msg}`;
        t.appendChild(el); setTimeout(()=> { el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, 2000);
    };

    window.onload = () => {
        const saved = localStorage.getItem(KEY);
        if(saved) { try { d = { ...DEFAULT_DATA, ...JSON.parse(saved) }; } catch(e) {} } 
        else { 
            const old = localStorage.getItem('masterV56_7') || localStorage.getItem('masterV56_2');
            if(old) { try { d = { ...d, ...JSON.parse(old) }; save(); } catch(e){} }
        }
        if(!Array.isArray(d.missions)) d.missions = []; if(!Array.isArray(d.doneMissions)) d.doneMissions = [];
        
        checkDate(); render(); 
        if(d.run.on) startTimer(); 
        updateRunUI(); 
        setTimeout(() => { if(navigator.onLine) { initMap(); startGPS(); } else { isOffline=true; } }, 1000);
        setInterval(checkDate, 60000);
    };

    function save() { localStorage.setItem(KEY, JSON.stringify(d)); }

    // Data Doctor
    let doctorClickCount = 0;
    function openDataDoctor() { doctorClickCount++; if(doctorClickCount >= 5) { doctorClickCount = 0; scanForBackups(); $('doctorModal').classList.add('show'); } }
    function closeDoctorModal() { $('doctorModal').classList.remove('show'); }
    function scanForBackups() {
        const list = $('recoveryList'); list.innerHTML = "";
        const keys = ['masterV56_7', 'masterV56_6', 'masterV56_2', 'masterV56', 'masterV55_7'];
        keys.forEach(k => {
            const data = localStorage.getItem(k);
            if(data) { try { const json = JSON.parse(data); const cnt = json.logs ? json.logs.filter(l=>typeof l.s==='number').length : 0; list.innerHTML += `<div class="flex justify-between items-center bg-black p-2 rounded border border-gray-700"><div><div class="text-primary font-bold">${k}</div><div class="text-gray-400">${json.date || '?'} / ${cnt}ê±´</div></div><button onclick="recoverFromKey('${k}')" class="bg-gray-700 px-2 py-1 rounded text-white font-bold">ë³µì›</button></div>`; } catch(e){} }
        });
    }
    function recoverFromKey(k) { if(confirm("ë³µì›?")) { const d2=localStorage.getItem(k); if(d2){ d=JSON.parse(d2); save(); location.reload(); } } }
    function addManualFix() {
        const cnt=parseInt($('fixCount').value); const amt=parseInt($('fixAmount').value);
        if(!cnt||!amt)return alert("ì…ë ¥í•˜ì„¸ìš”");
        if(confirm(`${cnt}ê±´, ${amt}ì› ì¶”ê°€?`)) {
            d.logs.unshift({id:Date.now(),time:"ìˆ˜ë™ë³´ì •",ts:Date.now(),amt:amt,s:999,isManual:true});
            for(let i=0;i<cnt-1;i++) d.logs.push({id:Date.now()+i+1,time:"ë³´ì •",ts:Date.now(),amt:0,s:999});
            save(); render(); closeDoctorModal();
        }
    }
    function backup() { 
        const json = JSON.stringify(d);
        const blob = new Blob([json], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `Master_Backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function copyBackup() { const json = JSON.stringify(d); try { navigator.clipboard.writeText(json).then(() => { alert("ë³µì‚¬ì™„ë£Œ!"); }); } catch (e) { alert("ë³µì‚¬ ì‹¤íŒ¨"); } }
    function restore() { $('fileInput').click(); }
    function loadBackupFile(inp) { const f=inp.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ if(confirm("ë³µêµ¬?")){ d=JSON.parse(e.target.result); save(); location.reload(); }}; r.readAsText(f); } }

    function render() {
        const realLogs = d.logs.filter(l => typeof l.s === 'number' || l.s === 999); 
        const inc = d.logs.reduce((a,b)=>a+(b.amt||0),0); 
        const cnt = realLogs.length;
        setText('uiIncome', inc.toLocaleString()); setText('uiCount', cnt);
        
        const grid = $('slotGrid'); if(grid) { grid.innerHTML = ''; d.slots.forEach((s, i) => {
            let cls="border-gray-800 text-gray-500 hover:bg-gray-800/50", ico="fa-box", txt="ëŒ€ê¸°", anim="";
            if(s===1) { cls="bg-primary/10 border-primary text-primary shadow-[0_0_15px_rgba(249,115,22,0.1)]"; ico="fa-motorcycle"; txt="í”½ì—…ì¤‘"; anim="animate-pulse"; }
            if(s===2) { cls="bg-green-500/10 border-green-500 text-green-500"; ico="fa-check-circle"; txt="ë°°ë‹¬ì¤‘"; }
            grid.innerHTML += `<div onmousedown="handleSlotStart(${i})" ontouchstart="handleSlotStart(${i})" onmouseup="handleSlotEnd(${i})" ontouchend="handleSlotEnd(${i})" oncontextmenu="return false;" class="lovable-card h-28 flex flex-col items-center justify-center border cursor-pointer active:scale-95 transition-all ${cls} select-none"><i class="fas ${ico} text-3xl mb-2 ${anim}"></i><span class="font-bold text-sm">${i+1}. ${txt}</span></div>`;
        }); }

        d.logs.sort((a,b) => b.ts - a.ts);
        const list = $('logList'); if(list) { list.innerHTML = d.logs.length ? '' : '<div class="text-center text-xs text-gray-600 py-4">ê¸°ë¡ ì—†ìŒ</div>'; d.logs.forEach(l => {
            const isB = l.s === 'ğŸ'; const isM = l.s === 999;
            const badge = isB ? '<span class="text-yellow-500 mr-2 font-bold">BONUS</span>' : (isM ? '<span class="text-gray-500 mr-2 font-bold">ë³´ì •</span>' : `<span class="bg-gray-800 text-primary px-1.5 py-0.5 rounded mr-2 font-bold border border-gray-700">${l.s}</span>`);
            if(l.amt > 0 || !isM) list.innerHTML += `<div onclick="openEditLog(${l.id})" class="flex justify-between p-3 rounded-lg border border-gray-800 mb-2 bg-[#202023] active:bg-gray-700 transition-colors cursor-pointer"><div class="flex items-center text-xs text-gray-400">${badge} ${l.time} ${!isB && !isM && l.w ? `<i class="fas fa-${l.w==='rain'?'umbrella':l.w} ml-2 text-gray-600"></i>` : ''}</div><div class="font-bold text-white tracking-wide">${l.amt.toLocaleString()} <i class="fas fa-chevron-right text-[8px] ml-1 text-gray-600"></i></div></div>`;
        }); }

        const arch = $('archList'); if(arch) { arch.innerHTML = d.arch.length ? '' : '<div class="text-center text-xs text-gray-600 py-4">ì´ì „ ê¸°ë¡ ì—†ìŒ</div>'; [...d.arch].reverse().forEach((a, idx) => {
            const realIdx = d.arch.length - 1 - idx; 
            arch.innerHTML += `<div onclick="openEditArch(${realIdx})" class="flex justify-between p-3 rounded border border-gray-800 mb-2 bg-gray-800/20 active:bg-gray-800/40 cursor-pointer"><div class="text-xs text-gray-400 font-bold flex flex-col justify-center"><span>${a.date}</span><span class="text-[9px] text-gray-600 font-normal">${getKORDay(a.date)}</span></div><div class="text-right"><div class="font-bold text-primary">${a.inc.toLocaleString()}ì›</div><div class="text-[10px] text-gray-500">${a.count}ê±´ / ${(a.dst||0).toFixed(1)}km</div></div></div>`;
        }); }
        updateMissionUI(); updateRunUI(); renderInsights();
    }

    let pressTimer = null, isLongPress = false;
    function handleSlotStart(i) { isLongPress = false; pressTimer = setTimeout(() => { isLongPress = true; if(d.slots[i] !== 0) { d.slots[i] = 0; d.slotTs[i] = 0; save(); render(); navigator.vibrate?.(50); toast(`ìŠ¬ë¡¯ ${i+1} ì´ˆê¸°í™”`); } }, 500); }
    
    // [V56.8] Simplified Touch Logic (Remove Action Modal)
    function handleSlotEnd(i) { 
        if(pressTimer) clearTimeout(pressTimer); 
        if(!isLongPress) { 
            if(d.slots[i]===0) { 
                d.slots[i]=1; d.slotTs[i] = Date.now(); 
                toast(`ìŠ¬ë¡¯ ${i+1}: í”½ì—…`); save(); render(); 
            } 
            else if(d.slots[i]===1) { 
                d.slots[i]=2; // Direct Jump 1->2
                save(); render(); 
            } 
            else if(d.slots[i]===2) { openCreateModal(i); } 
        } 
    }

    function openCreateModal(i) { activeSlot = i; $('modalTitle').innerText = "ë°°ë‹¬ ì™„ë£Œ"; $('editLogId').value=""; $('editArchIdx').value=""; $('weatherSection').classList.remove('hidden'); $('btnDelete').classList.add('hidden'); const now=new Date(); $('modalTime').value=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`; $('modalAmount').value=''; const realLogs=d.logs.filter(l=>typeof l.s==='number'); $('modalAmount').placeholder=realLogs.length>0?Math.round(realLogs.reduce((a,b)=>a+b.amt,0)/realLogs.length/100)*100:3500; $('completeModal').classList.add('show'); setTimeout(()=>$('modalAmount').focus(),200); if(!isOffline) getWeather(); }
    function openEditLog(id) { const log=d.logs.find(l=>l.id===id); if(!log)return; $('modalTitle').innerText="ìˆ˜ì •"; $('editLogId').value=id; $('editArchIdx').value=""; $('weatherSection').classList.add('hidden'); $('btnDelete').classList.remove('hidden'); $('modalAmount').value=log.amt; $('modalTime').value=log.time; $('completeModal').classList.add('show'); }
    
    function openArchiveCreator() { $('archIdx').value = "-1"; $('archDate').value = new Date().toISOString().split('T')[0]; $('archCount').value = ""; $('archInc').value = ""; $('archiveModal').classList.add('show'); }
    function openEditArch(idx) { 
        const item=d.arch[idx]; if(!item)return; 
        $('archIdx').value = idx;
        try { const dateObj = new Date(item.date); const yyyy = dateObj.getFullYear(); const mm = String(dateObj.getMonth() + 1).padStart(2, '0'); const dd = String(dateObj.getDate()).padStart(2, '0'); $('archDate').value = `${yyyy}-${mm}-${dd}`; } catch(e) { $('archDate').value = ""; }
        $('archCount').value = item.count; $('archInc').value = item.inc; $('archiveModal').classList.add('show'); 
    }
    function closeArchiveModal() { $('archiveModal').classList.remove('show'); $('bulkCount').value=''; $('bulkAmount').value=''; }
    function saveArchive() {
        const idx = parseInt($('archIdx').value); const dateVal = $('archDate').value; const cnt = parseInt($('archCount').value); const inc = parseInt($('archInc').value);
        if(!dateVal || isNaN(cnt) || isNaN(inc)) return alert("ê°’ í™•ì¸");
        const dateStr = new Date(dateVal).toDateString();
        if (idx === -1) { d.arch.push({date: dateStr, count: cnt, inc: inc, dst: 0}); toast("ìƒì„±ë¨"); }
        else { d.arch[idx].date = dateStr; d.arch[idx].count = cnt; d.arch[idx].inc = inc; toast("ìˆ˜ì •ë¨"); }
        d.arch.sort((a,b) => new Date(a.date) - new Date(b.date)); save(); render(); closeArchiveModal();
    }
    function deleteArchive() { const idx = parseInt($('archIdx').value); if(idx === -1) return closeArchiveModal(); if(confirm("ì‚­ì œ?")) { d.arch.splice(idx, 1); save(); render(); closeArchiveModal(); toast("ì‚­ì œë¨"); } }
    function applyBulkAdd() {
        const addCnt = parseInt($('bulkCount').value) || 0; const addAmt = parseInt($('bulkAmount').value) || 0;
        if(addCnt === 0 && addAmt === 0) return;
        $('archCount').value = (parseInt($('archCount').value) || 0) + addCnt;
        $('archInc').value = (parseInt($('archInc').value) || 0) + addAmt;
        $('bulkCount').value = ''; $('bulkAmount').value = ''; toast("í•©ì‚°ë¨");
    }

    function closeModal() { $('completeModal').classList.remove('show'); $('modalAmount').blur(); }
    function submitComplete() { 
        const amt=parseInt($('modalAmount').value)||parseInt($('modalAmount').placeholder)||0; const timeStr=$('modalTime').value; const logId=$('editLogId').value; const archIdx=$('editArchIdx').value; 
        if(logId) { const idx=d.logs.findIndex(l=>l.id==logId); if(idx!==-1) { d.logs[idx].amt=amt; d.logs[idx].time=timeStr; const [h,m]=timeStr.split(':'); const dt=new Date(d.logs[idx].ts); dt.setHours(h,m); d.logs[idx].ts=dt.getTime(); toast("ìˆ˜ì •ë¨"); } }
        else if(archIdx!=="") { d.arch[archIdx].inc=amt; const c=prompt("ê±´ìˆ˜ ìˆ˜ì •",d.arch[archIdx].count); if(c) d.arch[archIdx].count=parseInt(c); toast("ìˆ˜ì •ë¨"); }
        else { 
            const now=new Date(); const [h,m]=timeStr.split(':'); now.setHours(h,m); 
            const dispatchTs = d.slotTs[activeSlot] || now.getTime(); 
            d.logs.unshift({id:Date.now(), time:timeStr, ts:now.getTime(), dispatchTs: dispatchTs, amt:amt, s:activeSlot+1, w:selW, lat:curPos.lat, lng:curPos.lng}); 
            d.slots[activeSlot]=0; d.slotTs[activeSlot]=0; 
            checkMsn(); toast(`${amt}ì› ì €ì¥`); 
        }
        closeModal(); save(); render(); 
    }
    function deleteEntry() { if(!confirm("ì‚­ì œ?"))return; const logId=$('editLogId').value; const archIdx=$('editArchIdx').value; if(logId) d.logs=d.logs.filter(l=>l.id!=logId); toast("ì‚­ì œë¨"); closeModal(); save(); render(); }

    function openMissionModal() { $('missionModal').classList.add('show'); renderMissionList(); }
    function closeMissionModal() { $('missionModal').classList.remove('show'); }
    
    function addMission() { 
        const tgt=parseInt($('newMsnTgt').value); const rwd=parseInt($('newMsnRwd').value); 
        const sTime = document.getElementById('newMsnStart').value;
        const eTime = document.getElementById('newMsnEnd').value;
        const dateVal = document.getElementById('newMsnDate').value;
        
        if(!tgt||!rwd || !sTime || !eTime) return toast("ì‹œê°„/ëª©í‘œ ì…ë ¥ í•„ìˆ˜"); 
        
        // Construct TS using Selected Date or Today
        const baseDate = dateVal ? new Date(dateVal) : new Date();
        const baseDateStr = baseDate.toDateString();
        
        const startTs = new Date(baseDateStr + ' ' + sTime).getTime();
        let endTs = new Date(baseDateStr + ' ' + eTime).getTime();
        if(endTs < startTs) endTs += 86400000;
        
        d.missions.push({id: Date.now(), tgt: tgt, rwd: rwd, startTs: startTs, endTs: endTs, sStr: sTime, eStr: eTime, dateStr: baseDateStr}); 
        d.missions.sort((a,b)=>a.tgt-b.tgt); 
        $('newMsnTgt').value=''; $('newMsnRwd').value=''; 
        save(); renderMissionList(); updateMissionUI(); 
    }
    function removeMission(id) { if(confirm("ì‚­ì œ?")) { d.missions=d.missions.filter(m=>m.id!==id); save(); renderMissionList(); updateMissionUI(); } }
    
    function getMissionProgress(m) { 
        let c=0;
        d.logs.forEach(l => {
            const checkTime = l.dispatchTs || l.ts;
            const isLog = typeof l.s==='number' || l.s===999;
            if(isLog && checkTime >= m.startTs && checkTime <= m.endTs) c++;
        });
        d.slots.forEach((s, i) => {
             if(s > 0 && d.slotTs[i] >= m.startTs && d.slotTs[i] <= m.endTs) c++;
        });
        return c; 
    }

    function renderMissionList() { const act=$('activeMissionList'); const done=$('doneMissionList'); act.innerHTML=d.missions.length?'':'<div class="text-gray-600 text-xs">ì—†ìŒ</div>'; d.missions.forEach(m=>{ const p=getMissionProgress(m); const timeLabel = `${m.sStr}~${m.eStr}`; act.innerHTML+=`<div class="flex justify-between items-center bg-[#27272a] p-3 rounded-lg border border-gray-700"><div class="flex flex-col"><div class="flex items-center"><span class="text-primary font-bold text-sm mr-1">${m.tgt}ê±´</span><span class="bg-blue-900 text-blue-300 text-[9px] px-1 rounded ml-1">${timeLabel}</span></div><span class="text-gray-500 text-[10px]">ì§„í–‰: ${p}ê±´</span></div><div class="flex items-center gap-3"><span class="text-white font-bold text-sm">+${m.rwd.toLocaleString()}</span><button onclick="removeMission(${m.id})" class="text-red-500 text-xs p-1"><i class="fas fa-trash"></i></button></div></div>`; }); done.innerHTML=d.doneMissions.length?'':'<div class="text-gray-600 text-xs">ì—†ìŒ</div>'; d.doneMissions.forEach(m=>{ done.innerHTML+=`<div class="flex justify-between items-center bg-green-900/20 p-3 rounded-lg border border-green-900/50"><div class="text-green-500 font-bold text-xs"><i class="fas fa-check mr-1"></i>${m.tgt}ê±´ ë‹¬ì„±</div><div class="text-white font-bold text-xs">+${m.rwd.toLocaleString()}ì›</div></div>`; }); }
    function checkMsn() { const ach=[], rem=[]; d.missions.forEach(m=>{ const curCnt = getMissionProgress(m); if(curCnt >= m.tgt) ach.push(m); else rem.push(m); }); if(ach.length>0) { ach.forEach(m=>{ d.logs.unshift({id:Date.now(),time:"ë¯¸ì…˜ì„±ê³µ",ts:Date.now(),amt:m.rwd,s:'ğŸ',isBonus:true}); d.doneMissions.unshift({tgt:m.tgt,rwd:m.rwd,ts:Date.now()}); toast(`ğŸ‰ ${m.tgt}ê±´ ë‹¬ì„±! +${m.rwd}`); }); d.missions=rem; save(); renderMissionList(); } updateMissionUI(); }
    function updateMissionUI() { const box=$('missionBox'); if(d.missions.length===0) { box.classList.add('hidden'); setText('missionBtnTxt','ë¯¸ì…˜'); return; } box.classList.remove('hidden'); setText('missionBtnTxt','ì§„í–‰ì¤‘'); box.innerHTML=''; d.missions.forEach(m=>{ const p=getMissionProgress(m); const pct=Math.min(100,(p/m.tgt)*100); const l=`${m.sStr}~${m.eStr}`; box.innerHTML+=`<div class="mb-1"><div class="flex justify-between text-[9px] text-gray-400 mb-0.5 px-1"><span>${l} <b class="text-white">${m.tgt}</b>ê±´</span><span>${p}/${m.tgt}</span></div><div class="h-1.5 bg-secondary rounded-full overflow-hidden border border-white/5 relative"><div class="h-full bg-gradient-to-r from-orange-500 to-yellow-500" style="width:${pct}%"></div></div></div>`; }); }

    function setWeather(w) { selW=w; ['w-sun','w-cloud','w-rain','w-snow'].forEach(id=>$(id).classList.remove('border-primary','text-primary')); $('w-'+w).classList.add('border-primary','text-primary'); }
    async function getWeather() { if(isOffline||!curPos.lat) return setText('weatherStatus',"ì˜¤í”„ë¼ì¸/ìœ„ì¹˜ì—†ìŒ"); try { const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${curPos.lat}&longitude=${curPos.lng}&current_weather=true`); const json=await res.json(); const c=json.current_weather.weathercode; if(c<=3)setWeather('sun');else if(c>=71)setWeather('snow');else if(c>=51)setWeather('rain');else setWeather('cloud'); setText('weatherStatus',"ë‚ ì”¨ì ìš©"); } catch(e){} }
    function getKORDay(dStr) { return ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(dStr).getDay()]; }
    
    function renderInsights() { 
        const rL=d.logs.filter(l=>typeof l.s==='number'||l.s===999); 
        const inc=rL.reduce((a,b)=>a+(b.amt||0),0); 
        setText('insAvg',rL.length>0?Math.round(inc/rL.length).toLocaleString():0); 
        
        // Golden Time
        const hInc = {};
        if (rL.length > 0) {
             rL.forEach(l=>{ 
                const h=new Date(l.ts).getHours(); 
                if(!hInc[h]) hInc[h] = 0;
                hInc[h] += (l.amt || 0);
            });
            let goldTime = "-", maxHInc = 0;
            for(const [h, val] of Object.entries(hInc)) {
                if(val > maxHInc) { maxHInc = val; goldTime = h + "ì‹œ"; }
            }
            setText('recTime', goldTime);
        } else { setText('recTime', '-'); }

        // Best Day (Archive + Today)
        const dStats = {};
        d.arch.forEach(a=>{ 
            const dy=new Date(a.date).getDay(); 
            if(!dStats[dy]) dStats[dy]={sum:0, cnt:0}; 
            dStats[dy].sum += a.inc; dStats[dy].cnt += 1; 
        }); 
        if (inc > 0) {
            const todayIdx = new Date().getDay();
            if(!dStats[todayIdx]) dStats[todayIdx]={sum:0, cnt:0};
            dStats[todayIdx].sum += inc; dStats[todayIdx].cnt += 1;
        }

        let bDay="-", maxD=0;
        for(let i=0;i<7;i++){ 
            if(dStats[i] && dStats[i].cnt>0) {
                const avg = dStats[i].sum / dStats[i].cnt;
                if(avg > maxD) { maxD=avg; bDay=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][i]+"ìš”ì¼"; }
            }
        }
        if(bDay==='-' && inc > 0) bDay = "ì˜¤ëŠ˜"; // Fallback
        
        setText('recDay', bDay);
        $('aiCoachMsg').innerHTML = (bDay!=="-") ? `ì‚¬ì¥ë‹˜, <b>${bDay}</b> ìˆ˜ìµì´ ìµœê³ ì…ë‹ˆë‹¤!` : "ë°ì´í„° ìˆ˜ì§‘ ì¤‘...";

        const hList=$('hourList'); 
        if(hList) { 
            hList.innerHTML=''; 
            const grp = {}; 
            rL.forEach(l=>{ const h=new Date(l.ts).getHours(); if(!grp[h])grp[h]={c:0}; grp[h].c++; });
            Object.keys(hInc).sort((a,b)=>b-a).forEach(h=>{ 
                hList.innerHTML+=`<div class="flex justify-between border-b border-gray-700 py-2"><span class="text-gray-400 font-mono text-xs w-10">${h}ì‹œ</span><div class="flex gap-4"><span class="text-primary font-bold">${grp[h]?.c||0}ê±´</span><span class="text-white w-16 text-right font-bold">${hInc[h].toLocaleString()}</span></div></div>`; 
            }); 
        } 
        
        if(d.run.on && d.run.start) setText('insHour', ((Date.now() - d.run.start)/3600000 > 0.1) ? (rL.length/((Date.now() - d.run.start)/3600000)).toFixed(1) : "0.0"); 
    }

    function toggleRun() { d.run.on=!d.run.on; if(d.run.on){ d.run.start=Date.now(); startTimer(); toast("ì‹œì‘"); } else { clearInterval(timerInt); toast("ì¢…ë£Œ"); } save(); updateRunUI(); }
    function startTimer() { if(timerInt) clearInterval(timerInt); timerInt=setInterval(updateRunUI,1000); updateRunUI(); }
    function updateRunUI() { 
        const btn=$('runBtn'); 
        if(!d.run.on) { btn.innerText="ìš´í–‰ì‹œì‘"; btn.className="bg-gray-700 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg"; $('trackStats').classList.add('hidden'); $('coachBox').classList.add('hidden'); $('liveDot').classList.add('hidden'); return; } 
        $('trackStats').classList.remove('hidden'); $('coachBox').classList.remove('hidden'); $('liveDot').classList.remove('hidden'); 
        btn.innerText="ì¢…ë£Œ"; btn.className="bg-red-900/50 text-red-400 border border-red-900 px-4 py-2 rounded-lg text-xs font-bold shadow-lg";
        const diff=Math.floor((Date.now()-d.run.start)/1000); const hh=String(Math.floor(diff/3600)).padStart(2,'0'); const mm=String(Math.floor((diff%3600)/60)).padStart(2,'0'); const ss=String(diff%60).padStart(2,'0'); setText('timer',`${hh}:${mm}:${ss}`);
        const completedCnt = d.logs.filter(l=>typeof l.s==='number'||l.s===999).length;
        const activeCnt = d.slots.filter(s => s > 0).length;
        const currentTotal = completedCnt + activeCnt;
        const tgtCnt = d.run.tCnt; const remCnt = tgtCnt - currentTotal;
        const now = new Date(); const [th, tm] = d.run.tTime.split(':'); const tgtDate = new Date(); tgtDate.setHours(th, tm, 0, 0); if(tgtDate < now) tgtDate.setDate(tgtDate.getDate() + 1);
        const remHr = (tgtDate - now) / 3600000;
        setText('uiTgtCnt', tgtCnt); setText('uiTgtTime', th);
        if (remCnt <= 0) { setText('uiMsg', "ëª©í‘œ ë‹¬ì„± ì™„ë£Œ!"); $('uiMsg').className="text-xs font-bold mt-1 text-green-500"; }
        else if (remHr <= 0) { setText('uiMsg', "ì‹œê°„ ì¢…ë£Œ"); $('uiMsg').className="text-xs font-bold mt-1 text-red-500"; }
        else { const pace = (remCnt / remHr).toFixed(1); setText('uiMsg', `ì‹œê°„ë‹¹ ${pace}ê°œ í•„ìš”`); $('uiMsg').className = `text-xs font-bold mt-1 ${parseFloat(pace)>5?'text-red-400':'text-green-400'}`; }
        const nowH = new Date(); nowH.setMinutes(0,0,0); const hRecs = d.logs.filter(l => l.ts >= nowH.getTime() && typeof l.s==='number');
        setText('valWage', hRecs.reduce((a,b)=>a+b.amt,0).toLocaleString()); setText('valPace', hRecs.length); setText('valGoal', Math.min(100, Math.round((d.logs.reduce((a,b)=>a+b.amt,0)/d.run.goal)*100)));
    }
    
    function setStrategy() { const c = prompt("ëª©í‘œ ê±´ìˆ˜", d.run.tCnt); if(c) d.run.tCnt=parseInt(c); const t = prompt("í‡´ê·¼ ì‹œê°„ (ì˜ˆ: 21:00)", d.run.tTime); if(t) d.run.tTime=t; save(); updateRunUI(); }
    function setGoal() { const g = prompt("ëª©í‘œ ê¸ˆì•¡", d.run.goal); if(g) d.run.goal=parseInt(g); save(); updateRunUI(); }

    function initMap() { if(map)return; map=L.map('map',{zoomControl:false,attributionControl:false}).setView([37.5665,126.9780],13); L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:20}).addTo(map); poly=L.polyline([],{color:'#f97316',weight:5,opacity:0.8}).addTo(map); if(d.path.length){ poly.setLatLngs(d.path); d.path.forEach(p=>L.circleMarker(p,{color:'#f97316',fillColor:'#f97316',radius:3,stroke:false,fillOpacity:0.5}).addTo(map)); if(d.path.length>1)map.fitBounds(poly.getBounds()); } }
    function startGPS() { if(!navigator.geolocation)return toast("GPSë¶ˆê°€"); if(watchId)navigator.geolocation.clearWatch(watchId); const opt={enableHighAccuracy:true,maximumAge:0,timeout:15000}; watchId=navigator.geolocation.watchPosition(p=>{ const {latitude:lat,longitude:lng}=p.coords; curPos={lat,lng}; if(!map)initMap(); setText('weatherStatus',"GPSì—°ê²°"); if(d.path.length>0){ const last=d.path[d.path.length-1]; const dist=6371*2*Math.atan2(Math.sqrt(Math.sin((lat-last[0])*Math.PI/360)**2+Math.cos(last[0]*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-last[1])*Math.PI/360)**2),Math.sqrt(1-(Math.sin((lat-last[0])*Math.PI/360)**2+Math.cos(last[0]*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin((lng-last[1])*Math.PI/360)**2))); if(dist>0.02){ d.dist+=dist; d.path.push([lat,lng]); poly.setLatLngs(d.path); L.circleMarker([lat,lng],{color:'#f97316',fillColor:'#f97316',radius:3,stroke:false,fillOpacity:0.5}).addTo(map); save(); } }else{ d.path.push([lat,lng]); } setText('uiDist',d.dist.toFixed(1)); }, e=>{ setText('weatherStatus',"GPSì‹ í˜¸ì•½í•¨"); }, opt); }
    function recenterMap() { if(map&&curPos.lat){ map.setView([curPos.lat,curPos.lng],16); }else toast("GPSí™•ì¸ì¤‘"); }
    function checkDate() { if(d.date!==new Date().toDateString()){ const rL=d.logs.filter(l=>typeof l.s==='number'); if(rL.length>0)d.arch.push({date:d.date,count:rL.length,inc:d.logs.reduce((a,b)=>a+b.amt,0),dst:d.dist}); d.date=new Date().toDateString(); d.logs=[]; d.slots=[0,0,0,0,0,0]; d.dist=0; d.path=[]; d.doneMissions=[]; d.run.on=false; save(); render(); } }
    function resetDay() { if(confirm("ì˜¤ëŠ˜ ê¸°ë¡ ë§ˆê°?")) { d.date="RESET"; checkDate(); } }
    function backup() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d)); a.download="Backup.json"; a.click(); }
    function copyBackup() { const json = JSON.stringify(d); try { navigator.clipboard.writeText(json).then(() => { alert("ë³µì‚¬ì™„ë£Œ!"); }); } catch (e) { alert("ë³µì‚¬ ì‹¤íŒ¨"); } }
    function restore() { $('fileInput').click(); }
    function loadBackupFile(inp) { const f=inp.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ if(confirm("ë³µêµ¬?")){ d=JSON.parse(e.target.result); save(); location.reload(); }}; r.readAsText(f); } }
    function go(n) { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); $('p'+n).classList.add('active'); document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('nav-active')); $('n'+n).classList.add('nav-active'); if(n===3&&map){ setTimeout(()=>map.invalidateSize(),200); recenterMap(); } }
</script>
</body>
</html>